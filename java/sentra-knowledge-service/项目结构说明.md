# sentra-knowledge-service é¡¹ç›®ç»“æ„æ–‡æ¡£

> æœ€åæ›´æ–°ï¼š2026-01-27
> ç‰ˆæœ¬ï¼šv1.0

---

## ğŸ“ é¡¹ç›®æ¦‚è§ˆ

**sentra-knowledge-service** æ˜¯Sentraå¹³å°çš„æ ¸å¿ƒçŸ¥è¯†åº“æœåŠ¡æ¨¡å—ï¼Œè´Ÿè´£æ–‡æ¡£ç®¡ç†ã€çŸ¥è¯†åº“æ„å»ºã€OCRå¤„ç†ã€ç« èŠ‚é‡æ„å’ŒçŸ¥è¯†å›¾è°±æ„å»ºç­‰åŠŸèƒ½ã€‚

**æŠ€æœ¯æ ˆ**ï¼š
- Java 17
- Spring Boot 3.2.0
- MyBatis-Plus (æ•°æ®è®¿é—®)
- RabbitMQ (æ¶ˆæ¯é˜Ÿåˆ—)
- MongoDB (æ–‡æ¡£å­˜å‚¨)
- Neo4j (çŸ¥è¯†å›¾è°±)
- SFTP (è¿œç¨‹æ–‡ä»¶å­˜å‚¨)

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
sentra-knowledge-service/
â”œâ”€â”€ src/main/java/com/sentra/knowledge/
â”‚   â”œâ”€â”€ client/                 # PythonæœåŠ¡å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ dto/               # Pythonæ¥å£DTO
â”‚   â”‚   â””â”€â”€ PythonKnowledgeClient.java
â”‚   â”œâ”€â”€ config/                # é…ç½®ç±»
â”‚   â”œâ”€â”€ consumer/              # RabbitMQæ¶ˆè´¹è€…
â”‚   â”œâ”€â”€ controller/            # REST APIæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ document/              # MongoDBæ–‡æ¡£å®ä½“
â”‚   â”œâ”€â”€ dto/                   # å†…éƒ¨DTO
â”‚   â”œâ”€â”€ entity/                # PostgreSQLå®ä½“
â”‚   â”œâ”€â”€ enums/                 # æšä¸¾ç±»
â”‚   â”œâ”€â”€ mapper/                # MyBatis-Plus Mapper
â”‚   â”œâ”€â”€ messaging/             # æ¶ˆæ¯é˜Ÿåˆ—DTO
â”‚   â”œâ”€â”€ service/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â””â”€â”€ impl/              # ä¸šåŠ¡é€»è¾‘å®ç°
â”‚   â””â”€â”€ util/                  # å·¥å…·ç±»
â””â”€â”€ src/main/resources/
    â”œâ”€â”€ application.yml        # åº”ç”¨é…ç½®
    â””â”€â”€ ...
```

---

## ğŸ“¦ åŒ…ç»“æ„è¯¦è§£

### 1. `client/` - PythonæœåŠ¡å®¢æˆ·ç«¯

**ä½œç”¨**ï¼šè´Ÿè´£ä¸Python FastAPIæœåŠ¡çš„é€šä¿¡ï¼Œè°ƒç”¨Pythonç«¯çš„æ–‡æ¡£å¤„ç†å’ŒçŸ¥è¯†åº“æ„å»ºæ¥å£ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `PythonKnowledgeClient.java`
- **ä½œç”¨**ï¼šæ ¸å¿ƒPythonæœåŠ¡å®¢æˆ·ç«¯
- **ä¸»è¦æ–¹æ³•**ï¼š
  - `parseMarkdown()` - è°ƒç”¨Python mdParseæ¥å£è¿›è¡Œç« èŠ‚é‡æ„
  - `buildKnowledgeBase()` - è°ƒç”¨Python KbPipelineæ¥å£æ„å»ºçŸ¥è¯†åº“
  - `deleteDocumentFromKnowledgeBase()` - åˆ é™¤æ–‡æ¡£çŸ¥è¯†åº“æ•°æ®
  - `deleteKnowledgeBase()` - åˆ é™¤çŸ¥è¯†åº“æ•°æ®
- **ä¾èµ–**ï¼šSpring RestTemplate
- **é…ç½®**ï¼š`sentra.python.base-url` (é»˜è®¤: http://localhost:8000)

#### `dto/` ç›®å½•
- **`KbPipelineRequest.java`** - çŸ¥è¯†åº“æ„å»ºè¯·æ±‚DTO
  - `docID` - æ–‡æ¡£ID
  - `kbID` - çŸ¥è¯†åº“ID
  - `content` - Markdownå†…å®¹
  - `title` - æ–‡æ¡£æ ‡é¢˜
  - `entityTypes` - å®ä½“ç±»å‹åˆ—è¡¨ `List[str]`
  - `entityTypesDes` - å®ä½“ç±»å‹æè¿° `Dict[str, str]`

- **`KbPipelineResponse.java`** - çŸ¥è¯†åº“æ„å»ºå“åº”DTO
  - `status` - å¤„ç†çŠ¶æ€
  - `totalChunks` - åˆ‡å—æ•°é‡
  - `totalEntities` - å®ä½“æ•°é‡
  - `totalEdges` - å…³ç³»æ•°é‡
  - `totalQac` - é—®ç­”å¯¹æ•°é‡

- **`MdParseRequest.java`** - ç« èŠ‚é‡æ„è¯·æ±‚DTO
- **`MdParseResponse.java`** - ç« èŠ‚é‡æ„å“åº”DTO

---

### 2. `config/` - é…ç½®ç±»

**ä½œç”¨**ï¼šSpring Booté…ç½®ç±»ï¼ŒåŒ…æ‹¬RabbitMQã€å­˜å‚¨ã€SFTPç­‰é…ç½®ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `RabbitMQConfig.java`
- **ä½œç”¨**ï¼šRabbitMQé˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šé…ç½®
- **é˜Ÿåˆ—å®šä¹‰**ï¼š
  - `sentra.ocr.queue` - OCRå¤„ç†é˜Ÿåˆ—
  - `sentra.kb_build.queue` - çŸ¥è¯†åº“æ„å»ºé˜Ÿåˆ—
  - `sentra.dlq` - æ­»ä¿¡é˜Ÿåˆ—
- **äº¤æ¢æœºå®šä¹‰**ï¼š
  - `sentra.ocr.exchange` - OCRäº¤æ¢æœº
  - `sentra.kb_build.exchange` - KBæ„å»ºäº¤æ¢æœº
  - `sentra.dlq.exchange` - æ­»ä¿¡äº¤æ¢æœº

#### `StorageProperties.java`
- **ä½œç”¨**ï¼šå­˜å‚¨è·¯å¾„é…ç½®å±æ€§ç±»
- **é…ç½®é¡¹**ï¼š
  - `sftp.uploadPath` - SFTPä¸Šä¼ è·¯å¾„
  - `sftp.ocrOutputPath` - OCRç»“æœè¾“å‡ºè·¯å¾„
  - `graphPath` - æœ¬åœ°å›¾è°±å­˜å‚¨è·¯å¾„

---

### 3. `consumer/` - RabbitMQæ¶ˆè´¹è€…

**ä½œç”¨**ï¼šç›‘å¬RabbitMQé˜Ÿåˆ—ï¼Œå¼‚æ­¥å¤„ç†æ–‡æ¡£è§£æå’ŒçŸ¥è¯†åº“æ„å»ºä»»åŠ¡ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `OcrConsumer.java`
- **ä½œç”¨**ï¼šOCRä»»åŠ¡æ¶ˆè´¹è€…
- **ç›‘å¬é˜Ÿåˆ—**ï¼š`sentra.ocr.queue`
- **å¤„ç†æµç¨‹**ï¼š
  1. ä»SFTPä¸‹è½½PDFæ–‡ä»¶
  2. è°ƒç”¨MinerU OCR APIè§£ææ–‡æ¡£
  3. ä¿å­˜OCRç»“æœåˆ°MongoDB
  4. è°ƒç”¨Python mdParseæ¥å£é‡æ„ç« èŠ‚
  5. å‘é€åˆ°çŸ¥è¯†åº“æ„å»ºé˜Ÿåˆ—
- **é‡è¯•æœºåˆ¶**ï¼šæœ€å¤š3æ¬¡ï¼Œå¤±è´¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
- **è¿›åº¦è·Ÿè¸ª**ï¼š10% â†’ 30% â†’ 70% â†’ 80% â†’ 90%

#### `KbBuildConsumer.java`
- **ä½œç”¨**ï¼šçŸ¥è¯†åº“æ„å»ºä»»åŠ¡æ¶ˆè´¹è€…
- **ç›‘å¬é˜Ÿåˆ—**ï¼š`sentra.kb_build.queue`
- **å¤„ç†æµç¨‹**ï¼š
  1. æŸ¥è¯¢æ–‡æ¡£ä¿¡æ¯å’Œå®ä½“ç±»å‹é…ç½®
  2. ä»MongoDBè·å–ç« èŠ‚é‡æ„åçš„å†…å®¹
  3. è°ƒç”¨Python KbPipelineæ¥å£æ„å»ºçŸ¥è¯†åº“
  4. æ›´æ–°MongoDBå’ŒPostgreSQL
- **é‡è¯•æœºåˆ¶**ï¼šæœ€å¤š3æ¬¡ï¼Œå¤±è´¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
- **è¿›åº¦è·Ÿè¸ª**ï¼š95% â†’ 100%

---

### 4. `controller/` - REST APIæ§åˆ¶å™¨

**ä½œç”¨**ï¼šå¯¹å¤–æä¾›RESTful APIæ¥å£ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `KnowledgeBaseController.java`
- **ä½œç”¨**ï¼šçŸ¥è¯†åº“ç®¡ç†API
- **åŸºç¡€è·¯å¾„**ï¼š`/v1/kb`
- **æ¥å£åˆ—è¡¨**ï¼š
  - `POST /v1/kb` - åˆ›å»ºçŸ¥è¯†åº“
  - `GET /v1/kb/{kbId}` - è·å–çŸ¥è¯†åº“è¯¦æƒ…
  - `GET /v1/kb/list` - è·å–ç§Ÿæˆ·çŸ¥è¯†åº“åˆ—è¡¨
  - `GET /v1/kb/owner/{ownerUserId}` - è·å–ç”¨æˆ·çŸ¥è¯†åº“åˆ—è¡¨
  - `PUT /v1/kb/{kbId}` - æ›´æ–°çŸ¥è¯†åº“
  - `DELETE /v1/kb/{kbId}` - åˆ é™¤çŸ¥è¯†åº“ï¼ˆçº§è”åˆ é™¤æ‰€æœ‰æ–‡æ¡£ï¼‰

#### `DocumentController.java`
- **ä½œç”¨**ï¼šæ–‡æ¡£ç®¡ç†API
- **åŸºç¡€è·¯å¾„**ï¼š`/v1/document`
- **æ¥å£åˆ—è¡¨**ï¼š
  - `POST /v1/document/upload` - ä¸Šä¼ æ–‡æ¡£
  - `GET /v1/document/{documentId}` - è·å–æ–‡æ¡£è¯¦æƒ…
  - `GET /v1/document/list?kbId={kbId}` - è·å–æ–‡æ¡£åˆ—è¡¨
  - `DELETE /v1/document/{documentId}` - åˆ é™¤æ–‡æ¡£ï¼ˆçº§è”åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ï¼‰

#### `EntityTypeTemplateController.java`
- **ä½œç”¨**ï¼šå®ä½“ç±»å‹æ¨¡æ¿ç®¡ç†API
- **åŸºç¡€è·¯å¾„**ï¼š`/v1/knowledge/entity-template`
- **æ¥å£åˆ—è¡¨**ï¼š
  - `POST /v1/knowledge/entity-template` - åˆ›å»ºæ¨¡æ¿
  - `GET /v1/knowledge/entity-template/{templateId}` - è·å–æ¨¡æ¿è¯¦æƒ…
  - `GET /v1/knowledge/entity-template` - è·å–ç§Ÿæˆ·æ¨¡æ¿åˆ—è¡¨
  - `GET /v1/knowledge/entity-template/system` - è·å–ç³»ç»Ÿæ¨¡æ¿
  - `PUT /v1/knowledge/entity-template/{templateId}` - æ›´æ–°æ¨¡æ¿
  - `DELETE /v1/knowledge/entity-template/{templateId}` - åˆ é™¤æ¨¡æ¿

---

### 5. `document/` - MongoDBæ–‡æ¡£å®ä½“

**ä½œç”¨**ï¼šMongoDBæ–‡æ¡£ç»“æ„çš„å®ä½“ç±»å®šä¹‰ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `DocumentContent.java`
- **ä½œç”¨**ï¼šMongoDBæ–‡æ¡£å†…å®¹å®ä½“
- **é›†åˆå‘½å**ï¼šä½¿ç”¨kbIdä½œä¸ºé›†åˆåï¼ˆå¦‚ `kb_abc123`ï¼‰
- **ä¸»è¦å­—æ®µ**ï¼š
  - `documentId` - æ–‡æ¡£ID
  - `kbId` - çŸ¥è¯†åº“ID
  - `mdContent` - OCRåŸå§‹Markdown
  - `newMdContent` - ç« èŠ‚é‡æ„åçš„Markdown
  - `documentUniqueId` - Pythonè¿”å›çš„æ–‡æ¡£å”¯ä¸€æ ‡è¯†
  - `status` - æ–‡æ¡£çŠ¶æ€
  - `progress` - å¤„ç†è¿›åº¦
  - `parsedAt`, `restructuredAt`, `kbBuiltAt` - å„é˜¶æ®µæ—¶é—´æˆ³

---

### 6. `dto/` - å†…éƒ¨æ•°æ®ä¼ è¾“å¯¹è±¡

**ä½œç”¨**ï¼šæœåŠ¡é—´æ•°æ®ä¼ è¾“çš„DTOç±»ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

- **`KnowledgeBaseCreateRequest.java`** - çŸ¥è¯†åº“åˆ›å»ºè¯·æ±‚
- **`KnowledgeBaseUpdateRequest.java`** - çŸ¥è¯†åº“æ›´æ–°è¯·æ±‚
- **`KnowledgeBaseResponse.java`** - çŸ¥è¯†åº“å“åº”
- **`EntityTypeTemplateCreateRequest.java`** - å®ä½“ç±»å‹æ¨¡æ¿åˆ›å»ºè¯·æ±‚
- **`EntityTypeTemplateResponse.java`** - å®ä½“ç±»å‹æ¨¡æ¿å“åº”
- **`EntityTypeDefinitionRequest.java`** - å®ä½“ç±»å‹å®šä¹‰è¯·æ±‚
- **`EntityTypeDefinitionResponse.java`** - å®ä½“ç±»å‹å®šä¹‰å“åº”

---

### 7. `entity/` - PostgreSQLå®ä½“

**ä½œç”¨**ï¼šMyBatis-Pluså®ä½“ç±»ï¼Œå¯¹åº”PostgreSQLæ•°æ®åº“è¡¨ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `KnowledgeBase.java`
- **ä½œç”¨**ï¼šçŸ¥è¯†åº“å®ä½“
- **è¡¨å**ï¼š`t_knowledge_base`
- **ä¸»è¦å­—æ®µ**ï¼š
  - `kbId` - çŸ¥è¯†åº“å”¯ä¸€ID
  - `name` - çŸ¥è¯†åº“åç§°
  - `ownerUserId` - æ‰€æœ‰è€…ç”¨æˆ·ID
  - `scope` - èŒƒå›´ï¼ˆTENANT/USERï¼‰
  - `entityTemplateId` - å®ä½“ç±»å‹æ¨¡æ¿ID

#### `Document.java`
- **ä½œç”¨**ï¼šæ–‡æ¡£å®ä½“
- **è¡¨å**ï¼š`t_document`
- **ä¸»è¦å­—æ®µ**ï¼š
  - `documentId` - æ–‡æ¡£å”¯ä¸€ID
  - `kbId` - æ‰€å±çŸ¥è¯†åº“ID
  - `filename` - æ–‡ä»¶å
  - `remoteFilePath` - SFTPæ–‡ä»¶è·¯å¾„
  - `ocrResultPath` - OCRç»“æœè·¯å¾„
  - `status` - æ–‡æ¡£çŠ¶æ€
  - `progress` - å¤„ç†è¿›åº¦
  - `documentUniqueId` - Pythonè¿”å›çš„å”¯ä¸€æ ‡è¯†

#### `EntityTypeTemplate.java`
- **ä½œç”¨**ï¼šå®ä½“ç±»å‹æ¨¡æ¿å®ä½“
- **è¡¨å**ï¼š`t_entity_type_template`
- **ä¸»è¦å­—æ®µ**ï¼š
  - `name` - æ¨¡æ¿åç§°
  - `isSystem` - æ˜¯å¦ç³»ç»Ÿæ¨¡æ¿
  - `isActive` - æ˜¯å¦æ¿€æ´»

#### `EntityTypeDefinition.java`
- **ä½œç”¨**ï¼šå®ä½“ç±»å‹å®šä¹‰å®ä½“
- **è¡¨å**ï¼š`t_entity_type_definition`
- **ä¸»è¦å­—æ®µ**ï¼š
  - `templateId` - æ‰€å±æ¨¡æ¿ID
  - `entityCode` - å®ä½“ç¼–ç 
  - `entityName` - å®ä½“åç§°
  - `entityDescription` - å®ä½“æè¿°

---

### 8. `enums/` - æšä¸¾ç±»

**ä½œç”¨**ï¼šç³»ç»Ÿæšä¸¾å®šä¹‰ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

- **`DocumentParseStrategy.java`** - æ–‡æ¡£è§£æç­–ç•¥ï¼ˆPDFã€TXTç­‰ï¼‰
- **`KnowledgeType.java`** - çŸ¥è¯†åº“ç±»å‹ï¼ˆDOCUMENTã€GRAPHç­‰ï¼‰

---

### 9. `mapper/` - MyBatis-Plus Mapper

**ä½œç”¨**ï¼šæ•°æ®åº“è®¿é—®å±‚æ¥å£ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

- **`KnowledgeBaseMapper.java`** - çŸ¥è¯†åº“Mapper
- **`DocumentMapper.java`** - æ–‡æ¡£Mapper
- **`EntityTypeTemplateMapper.java`** - å®ä½“ç±»å‹æ¨¡æ¿Mapper
- **`EntityTypeDefinitionMapper.java`** - å®ä½“ç±»å‹å®šä¹‰Mapper

æ‰€æœ‰Mapperç»§æ‰¿è‡ª`BaseMapper<T>`ï¼Œæä¾›CRUDåŸºç¡€æ“ä½œã€‚

---

### 10. `messaging/` - æ¶ˆæ¯é˜Ÿåˆ—DTO

**ä½œç”¨**ï¼šRabbitMQæ¶ˆæ¯çš„æ•°æ®ç»“æ„ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `OcrTaskMessage.java`
- **ä½œç”¨**ï¼šOCRä»»åŠ¡æ¶ˆæ¯
- **ä¸»è¦å­—æ®µ**ï¼š
  - `documentId` - æ–‡æ¡£ID
  - `kbId` - çŸ¥è¯†åº“ID
  - `remoteFilePath` - SFTPæ–‡ä»¶è·¯å¾„
  - `filename` - æ–‡ä»¶å
  - `ocrOutputDir` - OCRè¾“å‡ºç›®å½•
  - `retryCount` - é‡è¯•æ¬¡æ•°

#### `KbBuildTaskMessage.java`
- **ä½œç”¨**ï¼šçŸ¥è¯†åº“æ„å»ºä»»åŠ¡æ¶ˆæ¯
- **ä¸»è¦å­—æ®µ**ï¼š
  - `documentId` - æ–‡æ¡£ID
  - `kbId` - çŸ¥è¯†åº“ID
  - `newMdContent` - ç« èŠ‚é‡æ„åçš„Markdown
  - `retryCount` - é‡è¯•æ¬¡æ•°

---

### 11. `service/` - ä¸šåŠ¡é€»è¾‘å±‚

**ä½œç”¨**ï¼šå®šä¹‰ä¸šåŠ¡é€»è¾‘æ¥å£ã€‚

**ä¸»è¦æ¥å£**ï¼š

#### `IKnowledgeBaseService.java`
- **ä½œç”¨**ï¼šçŸ¥è¯†åº“ç®¡ç†æœåŠ¡æ¥å£
- **æ–¹æ³•**ï¼š
  - `createKnowledgeBase()` - åˆ›å»ºçŸ¥è¯†åº“
  - `updateKnowledgeBase()` - æ›´æ–°çŸ¥è¯†åº“
  - `deleteKnowledgeBase()` - åˆ é™¤çŸ¥è¯†åº“
  - `getKnowledgeBaseByKbId()` - è·å–çŸ¥è¯†åº“è¯¦æƒ…
  - `listByTenantId()` - æŸ¥è¯¢ç§Ÿæˆ·çŸ¥è¯†åº“åˆ—è¡¨
  - `listByOwner()` - æŸ¥è¯¢ç”¨æˆ·çŸ¥è¯†åº“åˆ—è¡¨

#### `IDocumentService.java`
- **ä½œç”¨**ï¼šæ–‡æ¡£ç®¡ç†æœåŠ¡æ¥å£
- **æ–¹æ³•**ï¼š
  - `upload()` - ä¸Šä¼ æ–‡æ¡£
  - `deleteDocument()` - åˆ é™¤æ–‡æ¡£

#### `IDocumentContentService.java`
- **ä½œç”¨**ï¼šMongoDBæ–‡æ¡£å†…å®¹æœåŠ¡æ¥å£
- **æ–¹æ³•**ï¼š
  - `save()` - ä¿å­˜æ–‡æ¡£å†…å®¹
  - `getByDocumentId()` - æŸ¥è¯¢æ–‡æ¡£å†…å®¹
  - `update()` - æ›´æ–°æ–‡æ¡£å†…å®¹
  - `deleteByDocumentId()` - åˆ é™¤æ–‡æ¡£å†…å®¹
  - `createFromDocument()` - ä»PostgreSQLå®ä½“åˆ›å»ºMongoDBæ–‡æ¡£

#### `IEntityTypeTemplateService.java`
- **ä½œç”¨**ï¼šå®ä½“ç±»å‹æ¨¡æ¿æœåŠ¡æ¥å£
#### `IEntityTypeDefinitionService.java`
- **ä½œç”¨**ï¼šå®ä½“ç±»å‹å®šä¹‰æœåŠ¡æ¥å£
#### `IKnowledgeBaseService.java`
- **ä½œç”¨**ï¼šçŸ¥è¯†åº“æœåŠ¡æ¥å£

---

### 12. `service/impl/` - ä¸šåŠ¡é€»è¾‘å®ç°

**ä½œç”¨**ï¼šä¸šåŠ¡é€»è¾‘çš„å…·ä½“å®ç°ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `KnowledgeBaseServiceImpl.java`
- **ä½œç”¨**ï¼šçŸ¥è¯†åº“ç®¡ç†æœåŠ¡å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - åˆ›å»ºçŸ¥è¯†åº“å¹¶åˆå§‹åŒ–å­˜å‚¨ï¼ˆMongoDBé›†åˆ + Neo4jå‘½åç©ºé—´ + æœ¬åœ°ç›®å½•ï¼‰
  - åˆ é™¤çŸ¥è¯†åº“å¹¶çº§è”åˆ é™¤æ‰€æœ‰æ–‡æ¡£å’Œå­˜å‚¨
  - æ ¡éªŒçŸ¥è¯†åº“åç§°å”¯ä¸€æ€§
  - å…³è”å®ä½“ç±»å‹æ¨¡æ¿

#### `DocumentServiceImpl.java`
- **ä½œç”¨**ï¼šæ–‡æ¡£ç®¡ç†æœåŠ¡å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - ä¸Šä¼ æ–‡æ¡£åˆ°SFTPå¹¶å‘é€OCRä»»åŠ¡
  - åˆ é™¤æ–‡æ¡£å¹¶æ¸…ç†æ‰€æœ‰ç›¸å…³æ•°æ®ï¼š
    - SFTPæ–‡ä»¶ï¼ˆåŸå§‹PDF + OCRç»“æœï¼‰
    - PythonçŸ¥è¯†åº“æ•°æ®
    - æœ¬åœ°å›¾è°±GraphMLæ–‡ä»¶
    - Neo4jèŠ‚ç‚¹
    - MongoDBå†…å®¹
    - PostgreSQLè®°å½•

#### `DocumentContentServiceImpl.java`
- **ä½œç”¨**ï¼šMongoDBæ–‡æ¡£å†…å®¹æœåŠ¡å®ç°
- **æ ¸å¿ƒåŠŸèƒ½**ï¼š
  - ç®¡ç†MongoDBé›†åˆï¼ˆé›†åˆå=kbIdï¼‰
  - åˆ†é˜¶æ®µå­˜å‚¨æ–‡æ¡£å†…å®¹ï¼ˆOCR â†’ mdParse â†’ KB Buildï¼‰
  - æä¾›CRUDæ“ä½œ

#### `EntityTypeTemplateServiceImpl.java`
- **ä½œç”¨**ï¼šå®ä½“ç±»å‹æ¨¡æ¿æœåŠ¡å®ç°
#### `EntityTypeDefinitionServiceImpl.java`
- **ä½œç”¨**ï¼šå®ä½“ç±»å‹å®šä¹‰æœåŠ¡å®ç°

---

### 13. `util/` - å·¥å…·ç±»

**ä½œç”¨**ï¼šé€šç”¨å·¥å…·ç±»ã€‚

**æ–‡ä»¶è¯´æ˜**ï¼š

#### `KbIdGenerator.java`
- **ä½œç”¨**ï¼šçŸ¥è¯†åº“IDç”Ÿæˆå™¨
- **æ ¼å¼**ï¼š`{tenantId}_{ownerUserId}_{name}_{timestamp}`çš„å“ˆå¸Œå€¼

#### `SftpUtil.java`
- **ä½œç”¨**ï¼šSFTPæ–‡ä»¶æ“ä½œå·¥å…·ç±»
- **æ–¹æ³•**ï¼š
  - `uploadFile()` - ä¸Šä¼ æ–‡ä»¶åˆ°SFTP
  - `downloadFile()` - ä»SFTPä¸‹è½½æ–‡ä»¶
  - `deleteFile()` - åˆ é™¤SFTPæ–‡ä»¶

---

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. æ–‡æ¡£ä¸Šä¼ ä¸å¤„ç†æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ PDF
  â†“
DocumentController.upload()
  â†“
ä¸Šä¼ åˆ°SFTP + ä¿å­˜è®°å½•åˆ°PostgreSQL
  â†“
å‘é€OCRä»»åŠ¡åˆ°RabbitMQ (sentra.ocr.queue)
  â†“
OcrConsumerå¤„ç†:
  - ä¸‹è½½PDF
  - è°ƒç”¨MinerU OCR API
  - ä¿å­˜mdContentåˆ°MongoDB
  - è°ƒç”¨Python mdParseé‡æ„ç« èŠ‚
  - ä¿å­˜newMdContentåˆ°MongoDB
  â†“
å‘é€KBæ„å»ºä»»åŠ¡åˆ°RabbitMQ (sentra.kb_build.queue)
  â†“
KbBuildConsumerå¤„ç†:
  - åŠ è½½å®ä½“ç±»å‹é…ç½®
  - è°ƒç”¨Python KbPipelineæ„å»ºçŸ¥è¯†åº“
  - æ›´æ–°MongoDBå’ŒPostgreSQL
  â†“
æ–‡æ¡£å¤„ç†å®Œæˆ (status=COMPLETED)
```

### 2. åˆ é™¤æµç¨‹

#### æ–‡æ¡£åˆ é™¤
```
DocumentController.delete()
  â†“
DocumentServiceImpl.deleteDocument()
  â†“
1. åˆ é™¤SFTPåŸå§‹æ–‡ä»¶
  â†“
2. åˆ é™¤OCRç»“æœJSON
  â†“
3. è°ƒç”¨Pythonåˆ é™¤æ¥å£ (å‘é‡åº“+å›¾è°±åº“)
  â†“
4. åˆ é™¤æœ¬åœ°å›¾è°±GraphMLæ–‡ä»¶
  â†“
5. åˆ é™¤Neo4jèŠ‚ç‚¹
  â†“
6. åˆ é™¤MongoDBå†…å®¹
  â†“
7. åˆ é™¤PostgreSQLè®°å½•
```

#### çŸ¥è¯†åº“åˆ é™¤
```
KnowledgeBaseController.delete()
  â†“
KnowledgeBaseServiceImpl.deleteKnowledgeBase()
  â†“
1. æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£
  â†“
2. é€ä¸ªåˆ é™¤æ–‡æ¡£ï¼ˆè°ƒç”¨DocumentServiceImpl.deleteDocumentï¼‰
  â†“
3. è°ƒç”¨Pythonåˆ é™¤æ¥å£åˆ é™¤æ•´ä¸ªçŸ¥è¯†åº“
  â†“
4. åˆ é™¤MongoDBé›†åˆ
  â†“
5. åˆ é™¤æœ¬åœ°å›¾è°±ç›®å½•
  â†“
6. åˆ é™¤Neo4jå‘½åç©ºé—´
  â†“
7. åˆ é™¤PostgreSQLçŸ¥è¯†åº“è®°å½•
```

---

## ğŸ”Œ å¤–éƒ¨æœåŠ¡é›†æˆ

### 1. Python FastAPIæœåŠ¡
- **Base URL**: `http://localhost:8000`
- **æ¥å£åˆ—è¡¨**ï¼š
  - `POST /sentra/v1/knowledge/mdParse` - ç« èŠ‚é‡æ„
  - `POST /sentra/v1/knowledge/build` - çŸ¥è¯†åº“æ„å»º (KbPipeline)
  - `POST /sentra/v1/knowledge/delete` - åˆ é™¤æ–‡æ¡£çŸ¥è¯†åº“æ•°æ®
  - `POST /sentra/v1/knowledge/delete/kb` - åˆ é™¤çŸ¥è¯†åº“æ•°æ®

### 2. MinerU OCRæœåŠ¡
- **URL**: `http://172.16.107.15:30000/file_parse`
- **åŠŸèƒ½**ï¼šPDFæ–‡æ¡£è§£æï¼Œæå–Markdownå†…å®¹

### 3. RabbitMQ
- **ç«¯å£**: 5672
- **é˜Ÿåˆ—**: sentra.ocr.queue, sentra.kb_build.queue, sentra.dlq

### 4. PostgreSQL
- **ç«¯å£**: 5432
- **æ•°æ®åº“**: sentra_knowledge

### 5. MongoDB
- **ç«¯å£**: 27017
- **æ•°æ®åº“**: sentra_kb

### 6. Neo4j
- **ç«¯å£**: 7687
- **åŠŸèƒ½**: çŸ¥è¯†å›¾è°±å­˜å‚¨

### 7. SFTP
- **åŠŸèƒ½**: è¿œç¨‹æ–‡ä»¶å­˜å‚¨

---

## ğŸ“Š æ•°æ®å­˜å‚¨ç­–ç•¥

### PostgreSQL
- å­˜å‚¨ç»“æ„åŒ–æ•°æ®ï¼ˆçŸ¥è¯†åº“ã€æ–‡æ¡£ã€æ¨¡æ¿ç­‰å…ƒæ•°æ®ï¼‰

### MongoDB
- åŠ¨æ€é›†åˆå‘½åï¼ˆé›†åˆå=kbIdï¼‰
- å­˜å‚¨æ–‡æ¡£å¤„ç†è¿‡ç¨‹æ•°æ®ï¼ˆOCRç»“æœã€ç« èŠ‚é‡æ„ã€çŸ¥è¯†åº“æ„å»ºç»“æœï¼‰

### Neo4j
- å­˜å‚¨çŸ¥è¯†å›¾è°±èŠ‚ç‚¹å’Œå…³ç³»
- é€šè¿‡kbIdå®ç°çŸ¥è¯†åº“çº§åˆ«éš”ç¦»

### SFTP
- å­˜å‚¨åŸå§‹PDFæ–‡ä»¶
- å­˜å‚¨OCRç»“æœJSONæ–‡ä»¶

### æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
- å­˜å‚¨GraphMLå›¾è°±æ–‡ä»¶ï¼ˆ`{graphPath}/{kbId}/{documentUniqueId}.graphml`ï¼‰

---

## ğŸ› ï¸ é…ç½®è¯´æ˜

### application.yml å…³é”®é…ç½®

```yaml
sentra:
  python:
    base-url: http://localhost:8000  # PythonæœåŠ¡åœ°å€

spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/sentra_knowledge
  data:
    mongodb:
      uri: mongodb://localhost:27017
      database: sentra_kb
  rabbitmq:
    host: localhost
    port: 5672

storage:
  sftp:
    upload-path: /data/lzm/sentra/uploads
    ocr-output-path: /data/lzm/sentra/data/ocr_result
  graph-path: G:\é¡¹ç›®æˆæœæ‰“åŒ…\åŸºäºå›¾ç»“æ„çš„æ–‡æ¡£é—®ç­”åŠ©æ‰‹\logs\sentra\graph
```

---

## ğŸ“ å¾…å®ŒæˆåŠŸèƒ½

1. **Feignå®¢æˆ·ç«¯é›†æˆ** - å®ç°ä¸user-serviceçš„é€šä¿¡
2. **æ–‡æ¡£è¿›åº¦æŸ¥è¯¢API** - `GET /document/{id}/progress`
3. **æ‰¹é‡æ–‡æ¡£æ“ä½œ** - æ‰¹é‡ä¸Šä¼ ã€åˆ é™¤
4. **ç›‘æ§æŒ‡æ ‡** - Prometheusé›†æˆ
5. **å•å…ƒæµ‹è¯•** - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯•

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude Code Assistant
**æœ€åæ›´æ–°**: 2026-01-27
**ç‰ˆæœ¬**: v1.0
